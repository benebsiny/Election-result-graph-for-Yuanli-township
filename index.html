<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <style>
        * {
            font-family: 'Noto Sans TC', sans-serif;
        }

        html {
            height: 100%;
        }

        body {
            background-color: rgb(235, 235, 235);
            height: 100%;
        }

        h1 {
            text-align: center;
        }

        path {
            cursor: pointer;
            paint-order: stroke fill;
            stroke-width: 3;
            stroke: white;
            transition: all 0.2s linear;
        }

        path:hover {
            opacity: 0.7;
        }

        .info {
            left: 0;
            bottom: 0;
            transform: translateY(-100%);
            font-size: 1.5rem;
        }

        .legend-box {
            top: 0;
            right: 0;
        }

        .legend {
            width: 10px;
        }

        #svg {
            min-width: 800px;
            min-width: 800px;
            width: 100%;
        }

        @media screen and (min-width: 720px) and (max-width: 992px) {
            .info {
                position: relative !important;
                transform: translateY(-500px);
                margin-bottom: -500px !important;
            }
        }

        @media screen and (max-width: 720px) {
            .info {
                position: relative !important;
                transform: translateY(-500px);
                margin-bottom: -500px !important;
                font-size: 1rem;
            }

            .info h1 {
                font-size: 1.5rem;
            }

            .legend-box {
                position: relative !important;
                transform: translateY(-100px);
                margin-bottom: -100px !important;
            }
        }
    </style>

    <title>苑裡鎮各里投票地圖</title>
</head>

<body>
    <div class="d-flex flex-column h-100">

        <div class="container">
            <div class="row">
                <button class="mx-1 my-2 btn btn-outline-info active" id="2020-btn" data-year="2020">2020</button>
                <button class="mx-1 my-2 btn btn-outline-danger" id="2018-btn" data-year="2018">2018</button>
                <button class="mx-1 my-2 btn btn-outline-info" id="2016-btn" data-year="2016">2016</button>
                <button class="mx-1 my-2 btn btn-outline-danger" id="2014-btn" data-year="2014">2014</button>
                <button class="mx-1 my-2 btn btn-outline-info" id="2012-btn" data-year="2012">2012</button>
                <button class="mx-1 my-2 btn btn-outline-danger" id="2009-btn" data-year="2009">2009</button>
                <button class="mx-1 my-2 btn btn-outline-info" id="2008-btn" data-year="2008">2008</button>
            </div>
        </div>

        <div class="container-fluid flex-grow-1">
            <div class="row position-relative">
                <div class="col-md-12 col-sm-12 svg-wrapper p-0">
                    <h1>苑裡鎮<span class="title-year">2020總統大選</span></h1>
                    <svg id="svg" width="800px" height="600px" viewBox="0 0 800 600"></svg>
                </div>

                <div>
                    <div class="info d-flex flex-column position-absolute p-5 m-5">
                        <h1 class="village-name">苑港里</h1>
                        <div class="kmt">國民黨比率:<span class="kmt-ratio">23.29</span></div>
                        <div class="dpp">民進黨比率:<span class="dpp-ratio">71.8</span></div>
                        <div class="pfp">親民黨比率:<span class="pfp-ratio">4.91</span></div>
                        <div class="ind" style="display: none;">無黨籍比率:<span class="ind-ratio"></span></div>
                        <div class="hello" style="display: none; visibility: hidden;">你找到我了~</div>
                    </div>
                    <div class="legend-box d-flex flex-column position-absolute p-5 m-5">
                        <div>國民黨</div>
                        <div class="legend-kmt d-flex" style="width: 100px; height: 20px;">
                            <span class="legend flex-grow-1" style="background-color: #005178;"></span>
                            <span class="legend flex-grow-1" style="background-color: #09628E"></span>
                            <span class="legend flex-grow-1" style="background-color: #1273A3"></span>
                            <span class="legend flex-grow-1" style="background-color: #1B84B8"></span>
                            <span class="legend flex-grow-1" style="background-color: #2495CD"></span>
                            <span class="legend flex-grow-1" style="background-color: #48B2E5"></span>
                            <span class="legend flex-grow-1" style="background-color: #62BCE9"></span>
                            <span class="legend flex-grow-1" style="background-color: #7BC8ED"></span>
                        </div>
                        <div></div>
                        <div>民進黨</div>
                        <div class="legend-kmt d-flex" style="width: 100px; height: 20px;">
                            <span class="legend flex-grow-1" style="background-color: #325000;"></span>
                            <span class="legend flex-grow-1" style="background-color: #456A06"></span>
                            <span class="legend flex-grow-1" style="background-color: #58840C"></span>
                            <span class="legend flex-grow-1" style="background-color: #6B9E12"></span>
                            <span class="legend flex-grow-1" style="background-color: #7EB818"></span>
                            <span class="legend flex-grow-1" style="background-color: #94CF39"></span>
                            <span class="legend flex-grow-1" style="background-color: #A9DB53"></span>
                            <span class="legend flex-grow-1" style="background-color: #BEE76D"></span>
                        </div>
                        <div>無黨籍</div>
                        <div class="legend-kmt d-flex" style="width: 100px; height: 20px;">
                            <span class="legend flex-grow-1" style="background-color: #5B5B5B"></span>
                            <span class="legend flex-grow-1" style="background-color: #686868"></span>
                            <span class="legend flex-grow-1" style="background-color: #818181"></span>
                            <span class="legend flex-grow-1" style="background-color: #8E8E8E"></span>
                            <span class="legend flex-grow-1" style="background-color: #989898"></span>
                            <span class="legend flex-grow-1" style="background-color: #A2A2A2"></span>
                            <span class="legend flex-grow-1" style="background-color: #B5B5B5"></span>
                            <span class="legend flex-grow-1" style="background-color: #C9C9C9"></span>
                        </div>
                        <div><span style="float: left">80%</span><span style="float: right">50%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        let currentYear = 2020;

        // 更改年分
        $('.btn').on('click', function () {

            // 上方按鈕
            $('.btn').removeClass('active');
            $(this).toggleClass('active');

            // 全域變數
            currentYear = parseInt($(this).data('year'));

            // 標題
            if (currentYear % 4 === 0) $('.title-year').text(`${currentYear}總統大選`);
            else $('.title-year').text(`${currentYear}縣長選舉`);

            // 地圖內容
            drawSVG(currentYear);

            // 圖例
            if (currentYear === 2008 || currentYear === 2014) {
                $('.kmt').show();
                $('.dpp').show();
                $('.pfp').hide();
                $('.ind').hide();
                $('.hello').show();
            }
            else if (currentYear === 2009){
                $('.kmt').show();
                $('.dpp').show();
                $('.pfp').hide();
                $('.ind').show();
                $('.hello').hide();
            }
            else if (currentYear === 2018){
                $('.kmt').show();
                $('.dpp').hide();
                $('.pfp').hide();
                $('.ind').show();
                $('.hello').show();
            }
            else {
                $('.kmt').show();
                $('.dpp').show();
                $('.pfp').show();
                $('.ind').hide();
                $('.hello').hide();
            }

            // 詳細資料
            changeVillageInfo(currentYear, $('.village-name').text())
        });

        // 點選里
        $(document).on('mouseover', 'path', function () {

            let data;
            const thisVillage = $(this).data('village');

            $('.village-name').text(thisVillage);

            changeVillageInfo(currentYear, thisVillage);
        });

        function changeVillageInfo(year, village) {
            let data = getData(year, 'detail');

            for (let i = 0; i < 25; i++)
                if (data[i]['village'] === village)
                    content = data[i];

            $('.kmt-ratio').text((content['kmt']) ? content['kmt'].toFixed(2) : '');
            $('.dpp-ratio').text((content['dpp']) ? content['dpp'].toFixed(2) : '');
            $('.ind-ratio').text((content['ind']) ? content['ind'].toFixed(2) : '');
            $('.pfp-ratio').text((content['pfp']) ? content['pfp'].toFixed(2) : '');
        }


        let data2020, data_2018, data2016, data2014, data2012, data_2009, data2008;
        let data2020_detail, data_2018_detail, data2016_detail, data2014_detail, data2012_detail, data2009_detail, data2008_detail;
        let jsonFile;
        let geometry;
        let path;
        const width = 800;
        const height = 800;
        const url = './data/Yuanli_geography.geojson'; // GeoJSON的檔案路徑

        function getData(year, mode) {
            if (mode === 'overview') {
                switch (year) {
                    case 2020: return data2020;
                    case 2018: return data2018;
                    case 2016: return data2016;
                    case 2014: return data2014;
                    case 2012: return data2012;
                    case 2009: return data2009;
                    case 2008: return data2008;
                }
            }
            else if (mode === 'detail') {
                switch (year) {
                    case 2020: return data2020_detail;
                    case 2018: return data2018_detail;
                    case 2016: return data2016_detail;
                    case 2014: return data2014_detail;
                    case 2012: return data2012_detail;
                    case 2009: return data2009_detail;
                    case 2008: return data2008_detail;
                }
            }
        }

        function postData(year, mode, data) {
            if (mode === 'overview') {
                switch (year) {
                    case 2020: data2020 = data; break;
                    case 2018: data2018 = data; break;
                    case 2016: data2016 = data; break;
                    case 2014: data2014 = data; break;
                    case 2012: data2012 = data; break;
                    case 2009: data2009 = data; break;
                    case 2008: data2008 = data; break;
                }
            }
            else if (mode === 'detail') {
                switch (year) {
                    case 2020: data2020_detail = data; break;
                    case 2018: data2018_detail = data; break;
                    case 2016: data2016_detail = data; break;
                    case 2014: data2014_detail = data; break;
                    case 2012: data2012_detail = data; break;
                    case 2009: data2009_detail = data; break;
                    case 2008: data2008_detail = data; break;
                }
            }
        }

        // 打開JSON資料檔
        function openFile(year, mode) {

            let position = 'President';
            if (year % 4 !== 0) position = 'Mayor'


            jsonFile = new XMLHttpRequest();
            jsonFile.addEventListener("load", function () {
                const data = JSON.parse(this.responseText);

                postData(year, mode, data);

            });
            jsonFile.open('GET', `./data/${mode}/${year}${position}_${mode}.json`, false);
            jsonFile.send();
        }

        // 打開GEOJSON檔
        function openGeojson() {
            return new Promise(resolve => {
                d3.json(url, (error, geometrys) => {
                    if (error) throw error;
                    geometry = geometrys;
                    resolve();
                })
            })
        }


        function villageToColor(year, village) {
            let content;
            let data;

            // 檢查年分
            data = getData(year, 'overview');

            // 找到正確的里
            for (let i = 0; i < 25; i++)
                if (data[i]['village'] === village)
                    content = data[i];

            // 填上顏色
            if (content['party'] === '國民黨') {
                if (content['ratio'] > 80) return "#005178"
                if (content['ratio'] > 75) return "#09628E"
                if (content['ratio'] > 70) return "#1273A3"
                if (content['ratio'] > 65) return "#1B84B8"
                if (content['ratio'] > 60) return "#2495CD"
                if (content['ratio'] > 55) return "#48B2E5"
                if (content['ratio'] > 50) return "#62BCE9"
                return "#7BC8ED"
            }
            else if (content['party'] === '民進黨') {
                if (content['ratio'] > 80) return "#325000"
                if (content['ratio'] > 75) return "#456A06"
                if (content['ratio'] > 70) return "#58840C"
                if (content['ratio'] > 65) return "#6B9E12"
                if (content['ratio'] > 60) return "#7EB818"
                if (content['ratio'] > 55) return "#94CF39"
                if (content['ratio'] > 50) return "#A9DB53"
                return "#BEE76D"
            }
            else if (content['party'] === '無黨籍') {
                if (content['ratio'] > 80) return "#5B5B5B"
                if (content['ratio'] > 75) return "#686868"
                if (content['ratio'] > 70) return "#818181"
                if (content['ratio'] > 65) return "#8E8E8E"
                if (content['ratio'] > 60) return "#989898"
                if (content['ratio'] > 55) return "#A2A2A2"
                if (content['ratio'] > 50) return "#B5B5B5"
                return "#C9C9C9"
            }
            return "#EBEBEB"
        }

        function SVGBasicInfo() {
            let mercatorScale, w = window.screen.width;
            if (w > 1366) { mercatorScale = 11000; }
            else if (w <= 1366 && w > 480) { mercatorScale = 9000; }
            else { mercatorScale = 6000; }

            path = d3.geo.path().projection(
                d3.geo
                    .mercator()
                    .center([120.68, 24.42])
                    .scale(mercatorScale * 37)
                    .translate([width / 2, height / 2.5])
            );
        }

        function drawSVG(year) {
            $('#svg').empty();
            const svg = d3.select(`#svg`)
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`);

            svg
                .selectAll('path')
                .data(geometry.features)
                .enter().append('path')
                .attr('d', path)
                .attr('data-village', (feat) => {
                    return feat.properties.VILLAGE;
                })
                .attr('fill', (feat) => {
                    return villageToColor(year, feat.properties.VILLAGE)
                });
        }

        async function initDraw() {
            await openGeojson();
            drawSVG(2020);
        }

        openFile(2020, 'overview');
        openFile(2018, 'overview');
        openFile(2016, 'overview');
        openFile(2014, 'overview');
        openFile(2012, 'overview');
        openFile(2009, 'overview');
        openFile(2008, 'overview');

        openFile(2020, 'detail');
        openFile(2018, 'detail');
        openFile(2016, 'detail');
        openFile(2014, 'detail');
        openFile(2012, 'detail');
        openFile(2009, 'detail');
        openFile(2008, 'detail');

        SVGBasicInfo();
        initDraw();

    </script>
</body>

</html>